<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>竹弓 - 极简记账</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .gradient-text { background: linear-gradient(90deg, #10b981, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-secondary { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); }
        input[type="file"] { display: none; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
            <div>
                <h1 class="text-3xl font-bold gradient-text italic">竹弓</h1>
                <p class="text-slate-500 text-xs mt-1">记记账账</p>
            </div>
            <div class="flex gap-2">
                <button onclick="exportData()" class="btn-secondary hover:bg-white/10 px-3 py-2 rounded-lg text-xs transition">导出备份</button>
                <label class="btn-secondary hover:bg-white/10 px-3 py-2 rounded-lg text-xs cursor-pointer transition">
                    导入数据 <input type="file" id="importInput" onchange="importData(event)">
                </label>
                <button onclick="toggleModal()" class="bg-emerald-600 hover:bg-emerald-500 px-4 py-2 rounded-lg text-sm font-medium transition-all shadow-lg shadow-emerald-900/20">+ 新增记录</button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="glass-card p-6 rounded-2xl flex flex-col justify-center">
                <p class="text-slate-400 text-sm">当前资产净值</p>
                <h2 id="totalBalance" class="text-3xl font-bold mt-2">¥ 0.00</h2>
                <p id="statusLabel" class="text-xs mt-2 text-slate-500">等待记录...</p>
            </div>
            <div class="glass-card p-6 rounded-2xl md:col-span-2">
                <canvas id="mainChart" height="120"></canvas>
            </div>
        </div>

        <div class="glass-card rounded-2xl overflow-hidden shadow-xl">
            <div class="p-4 border-b border-white/10 bg-white/5 flex justify-between items-center">
                <h3 class="font-medium text-slate-300">历史流水</h3>
            </div>
            <div id="recordList" class="max-h-[500px] overflow-y-auto divide-y divide-white/5">
                </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-md flex items-center justify-center p-4 z-50">
        <div class="glass-card w-full max-w-md p-8 rounded-3xl shadow-2xl border-emerald-500/20">
            <h3 class="text-2xl mb-6 font-bold text-emerald-400">记一笔</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-xs text-slate-400 uppercase tracking-wider mb-2">日期</label>
                    <input type="date" id="dateInput" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 outline-none focus:border-emerald-500 transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 uppercase tracking-wider mb-2">金额 (收入为正，支出为负)</label>
                    <input type="number" id="amountInput" step="0.01" placeholder="0.00" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 text-xl font-mono outline-none focus:border-emerald-500 transition">
                </div>
                <div>
                    <label class="block text-xs text-slate-400 uppercase tracking-wider mb-2">备注 / 类别</label>
                    <input type="text" id="descInput" placeholder="例如：午餐、工资、理财收益" class="w-full bg-slate-900/50 border border-white/10 rounded-xl p-3 outline-none focus:border-emerald-500 transition">
                </div>
                <div class="flex gap-4 pt-6">
                    <button onclick="toggleModal()" class="flex-1 px-4 py-3 rounded-xl btn-secondary hover:bg-white/10 transition font-medium">取消</button>
                    <button onclick="saveRecord()" class="flex-1 px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500 transition font-bold shadow-lg shadow-emerald-900/40">保存记录</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let records = JSON.parse(localStorage.getItem('zhugong_records')) || [];
        let myChart;

        function toggleModal() {
            document.getElementById('modal').classList.toggle('hidden');
            document.getElementById('dateInput').valueAsDate = new Date();
        }

        function saveRecord() {
            const date = document.getElementById('dateInput').value;
            const amount = parseFloat(document.getElementById('amountInput').value);
            const desc = document.getElementById('descInput').value || (amount >= 0 ? '收入' : '支出');

            if (!date || isNaN(amount)) return alert('请输入有效的日期和金额');

            records.push({ date, amount, desc, id: Date.now() });
            saveAndRefresh();
            toggleModal();
            
            document.getElementById('amountInput').value = '';
            document.getElementById('descInput').value = '';
        }

        function deleteRecord(id) {
            if(confirm('确定要删除这条记录吗？')) {
                records = records.filter(r => r.id !== id);
                saveAndRefresh();
            }
        }

        function saveAndRefresh() {
            records.sort((a, b) => new Date(b.date) - new Date(a.date));
            localStorage.setItem('zhugong_records', JSON.stringify(records));
            updateUI();
        }

        // 导出功能
        function exportData() {
            if (records.length === 0) return alert('暂无数据可导出');
            const dataStr = JSON.stringify(records, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `竹弓数据备份_${new Date().toLocaleDateString()}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // 导入功能
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if (Array.isArray(imported)) {
                        if (confirm(`检测到 ${imported.length} 条记录，是否覆盖当前数据？`)) {
                            records = imported;
                            saveAndRefresh();
                            alert('导入成功！');
                        }
                    } else {
                        throw new Error();
                    }
                } catch (err) {
                    alert('文件格式错误，请确保导入的是有效的“竹弓”备份文件');
                }
            };
            reader.readAsText(file);
        }

        function updateUI() {
            const listEl = document.getElementById('recordList');
            const balanceEl = document.getElementById('totalBalance');
            const statusEl = document.getElementById('statusLabel');
            listEl.innerHTML = '';
            
            let total = 0;
            records.forEach(r => {
                total += r.amount;
                const item = document.createElement('div');
                item.className = 'p-4 flex justify-between items-center hover:bg-white/5 transition group';
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <div class="w-2 h-10 rounded-full ${r.amount >= 0 ? 'bg-emerald-500/20' : 'bg-rose-500/20'}"></div>
                        <div>
                            <p class="font-medium text-slate-200">${r.desc}</p>
                            <p class="text-xs text-slate-500 font-mono">${r.date}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <span class="${r.amount >= 0 ? 'text-emerald-400' : 'text-rose-400'} font-bold font-mono text-lg">
                            ${r.amount >= 0 ? '+' : ''}${r.amount.toFixed(2)}
                        </span>
                        <button onclick="deleteRecord(${r.id})" class="opacity-0 group-hover:opacity-100 text-slate-600 hover:text-rose-500 transition text-sm">删除</button>
                    </div>
                `;
                listEl.appendChild(item);
            });

            balanceEl.innerText = `¥ ${total.toFixed(2)}`;
            balanceEl.className = `text-4xl font-bold mt-2 ${total >= 0 ? 'text-emerald-400' : 'text-rose-400'}`;
            statusEl.innerText = total >= 0 ? "当前状态：盈利" : "当前状态：亏损";
            
            if (records.length === 0) listEl.innerHTML = '<div class="p-10 text-center text-slate-600 italic">尚无流水记录</div>';
            
            renderChart();
        }

        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (myChart) myChart.destroy();

            const chartData = [...records].sort((a, b) => new Date(a.date) - new Date(b.date));
            const labels = chartData.map(r => r.date);
            let cumulative = 0;
            const dataPoints = chartData.map(r => {
                cumulative += r.amount;
                return cumulative;
            });

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '资产走势',
                        data: dataPoints,
                        borderColor: '#10b981',
                        borderWidth: 3,
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { family: 'monospace' } } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { family: 'monospace' } } }
                    }
                }
            });
        }

        updateUI();
    </script>
</body>
</html>